@{
ViewData["Title"] = "Products";
}

<h3>Product List</h3>

<!-- Add / Update Product Form -->

    <div class="form-group">
        <input type="hidden" id="productId" /> <!-- used for update -->
        <input type="text" id="productName" placeholder="Name" class="form-control mb-2" required/>
        <input type="number" step="0.01" id="productPrice" placeholder="Price" class="form-control mb-2" required/>
        <button id="btnSave" class="btn btn-success">Save</button>
        <button id="btnCancel" class="btn btn-secondary" style="display:none;">Cancel</button>
    </div>

<br>
<table class="table table-bordered" id="productTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        loadProducts();

        // READ
        function loadProducts() {
            $.get('@Url.Action("GetProducts", "Home")', function (products) {
                var tbody = $("#productTable tbody");
                tbody.empty();

                $.each(products, function (index, product) {
                    var row = `<tr data-id="${product.id}">
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td >${parseFloat(product.price).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-primary btnEdit">Edit</button>
                        <button class="btn btn-danger btnDelete">Delete</button>
                    </td>
                </tr>`;
                    tbody.append(row);
                });
            });
        }

        // SAVE (Add or Update)
        $("#btnSave").click(function () {
            var product = {
                id: $("#productId").val() || 0,
                name: $("#productName").val(),
                price: parseFloat($("#productPrice").val())
            };

            let url = (product.id == 0)
                ? '@Url.Action("AddProduct", "Home")'
                : '@Url.Action("UpdateProduct", "Home")';

            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(product),
                success: function () {
                    resetForm();
                    loadProducts();
                }
            });
        });

        // EDIT → load into form
        $(document).on("click", ".btnEdit", function () {
            var row = $(this).closest("tr");
            $("#productId").val(row.data("id"));
            $("#productName").val(row.find("td:eq(1)").text());
            $("#productPrice").val(row.find("td:eq(2)").text());
            $("#btnCancel").show();
        });

        // DELETE
        $(document).on("click", ".btnDelete", function () {
            var id = $(this).closest("tr").data("id");

            if (confirm("Are you sure you want to delete this product?")) {
                $.ajax({
                    url: '@Url.Action("DeleteProduct", "Home")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(id),
                    success: function () {
                        loadProducts();
                        alert("Product deleted!");
                    }
                });
            }
});

        // CANCEL edit mode
        $("#btnCancel").click(function () {
            resetForm();
        });

        // Reset form to Add mode
        function resetForm() {
            $("#productId").val('');
            $("#productName").val('');
            $("#productPrice").val('');
            $("#btnCancel").hide();
        }
});
</script>
}
